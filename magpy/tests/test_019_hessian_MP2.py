import psi4
import magpy
import pytest
from ..data.molecules import *
import numpy as np
import os

np.set_printoptions(precision=10, linewidth=200, threshold=200, suppress=True)

def test_Hessian_H2O_STO3G():
    psi4.core.clean_options()
    psi4.set_memory('2 GB')
    psi4.set_output_file('output.dat', False)
    psi4.set_options({'scf_type': 'pk',
                      'e_convergence': 1e-13,
                      'd_convergence': 1e-13,
                      'r_convergence': 1e-13})

    psi4.set_options({'basis': 'STO-3G'})
    # CFOUR MP2/STO-3G optimized geometry
    mol = psi4.geometry("""
O  0.000000000000000  -0.000000000000000   0.141635981802241
H  0.000000000000000  -1.437405158329807  -1.123932904416828
H  0.000000000000000   1.437405158329807  -1.123932904416828
no_com
no_reorient
symmetry c1
units bohr
            """)

    hessian = magpy.Hessian(mol)
    hess = hessian.compute('MP2')

    # CFOUR MP2/STO-3G analytic Hessian
    hess_ref = np.array([
    [   0.0000000001,       -0.0000000000,       -0.0000000000],
    [  -0.0000000001,        0.0000000000,        0.0000000000],
    [  -0.0000000001,       -0.0000000000,        0.0000000000],
    [  -0.0000000000,        0.6608196899,       -0.0000000000],
    [   0.0000000000,       -0.3304098449,       -0.2909106155],
    [  -0.0000000000,       -0.3304098449,        0.2909106155],
    [  -0.0000000000,       -0.0000000000,        0.5495711873],
    [   0.0000000000,       -0.1762837568,       -0.2747855936],
    [   0.0000000000,        0.1762837568,       -0.2747855936],
    [  -0.0000000001,        0.0000000000,        0.0000000000],
    [   0.0000000000,       -0.0000000000,       -0.0000000000],
    [   0.0000000001,        0.0000000000,        0.0000000000],
    [   0.0000000000,       -0.3304098449,       -0.1762837569],
    [  -0.0000000000,        0.3678952802,        0.2335971862],
    [  -0.0000000000,       -0.0374854352,       -0.0573134293],
    [   0.0000000000,       -0.2909106156,       -0.2747855936],
    [  -0.0000000000,        0.2335971862,        0.2654594806],
    [   0.0000000000,        0.0573134294,        0.0093261131],
    [  -0.0000000001,       -0.0000000000,        0.0000000000],
    [   0.0000000001,       -0.0000000000,        0.0000000000],
    [   0.0000000000,        0.0000000000,       -0.0000000000],
    [  -0.0000000000,       -0.3304098449,        0.1762837569],
    [   0.0000000000,       -0.0374854352,        0.0573134293],
    [   0.0000000000,        0.3678952802,       -0.2335971862],
    [   0.0000000000,        0.2909106156,       -0.2747855936],
    [   0.0000000000,       -0.0573134294,        0.0093261131],
    [  -0.0000000000,       -0.2335971862,        0.2654594806],
    ])

    assert(np.max(np.abs(hess-hess_ref.reshape(9,9))) < 1e-5)

